---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# valhallr: A Tidy Interface to the Valhalla Routing Engine

<!-- badges: start -->
<!-- badges: end -->

This package provides an R-native interface to the Valhalla routing engine's API. *Please note* that at present it requires a local Valhalla instance running on port 8002.

* [API Documentation](https://valhalla.readthedocs.io/en/latest/api/turn-by-turn/api-reference/)

# Extremely Experimental!

This library is under active development and extremely experimental. Many things work but lots don't, there's little input validation, the API wrappers are not up to best practicesc yet, the documentation is a work in progress, and you can expect functions and parameters to change.

# Examples

## Turn-by-turn directions

This example shows how we can easily get turn-by-turn driving directions using many default parameters. Here's a driving trip from the University of Ottawa to the Canadian Tire Centre (an arena across town).

```{r message=FALSE, warning=FALSE}
library(valhallr)
library(magrittr)
library(dplyr)
# library(tibble)
# library(tidyr)

origin <- valhallr::test_data("uottawa")
destination <- valhallr::test_data("cdntirecentre")

trip <- valhallr::route(from = origin, to = destination)

valhallr::print_trip(trip, all_details = TRUE)


```

## Mapping turn-by-turn routes

And we can decode the API's encoded shapefile and map our turn-by-turn trip with the convenience function `valhallr::map_trip()`. Leaflet and ggplot are both supported; here we'll use ggplot since GitHub documents seem not to support embedded HTML Leaflet maps.

```{r message=FALSE, warning=FALSE}
valhallr::map_trip(trip, method = "ggplot")
```

## Origin-Destination analyses

There is also some basic support for origin-destination (OD) analyses using Valhalla's `sources_to_targets` method. You can either call the method directly with `valhallr::sources_to_targets()`, or else use `valhallr::od_matrix()` which has some convenience features like human-readable name columns.

```{r, message = FALSE, warning = FALSE}
origins <- bind_rows(test_data("uottawa"), test_data("cntower"))
destinations <- bind_rows(test_data("cdntirecentre"), test_data("parliament"))

od <- valhallr::od_matrix(froms = origins, 
                          from_id_col = "name", 
                          tos = destinations, 
                          to_id_col = "name",
                          costing = "auto",
                          batch_size = 100,
                          minimum_reachability = 500)

od %>%
  mutate(time = time / 3600,
         time = round(time, digits = 2)) %>%
  knitr::kable(col.names = c("Origin", "Destination", "Distance (km)", "Time (h)"))

```

## Isochrones

There is also a rudimentary function `valhallr::isochrone()` for generating isochrones, which are polygons showing how far you can travel in a given time from a given location. You specify a lat/lon origin in a tibble, and it returns an `sf` object with the according polygons.

This simple example shows how to generate 5, 10, and 15-minute walking isochrones:

```{r, message = FALSE, warning = FALSE}
library(sf)

origin <- valhallr::test_data("myhouse")

isochrones <- valhallr::isochrone(from = origin)

isochrones

```

There's also a simple function to map them via Leaflet or ggplot:

```{r, message = FALSE, warning = FALSE}
valhallr::map_isochrone(isochrones, method = "ggplot")
```


## Installation

You can install the developer version from GitHub.

